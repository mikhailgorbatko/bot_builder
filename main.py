import logging
import os
import time
import json
from threading import Thread

from flask import Flask, request
import requests

from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    ChatAction,
)
from telegram.ext import (
    Updater,
    CommandHandler,
    MessageHandler,
    Filters,
    ConversationHandler,
    CallbackContext,
)

# ---------- –õ–û–ì–ò ----------

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# ---------- –°–û–°–¢–û–Ø–ù–ò–Ø –î–ò–ê–õ–û–ì–ê ----------

(
    MAIN_MENU,
    MATERIAL_CATEGORY,
    COMPARE_FIRST,
    COMPARE_SECOND,
    REGION_NAME,
    REGION_CLIMATE,
    REGION_GROUND,
    MONTAGE_MATERIAL,
    CALC_MATERIAL,
    CALC_AREA,
    AI_QUESTION,
    ESTIMATE_AREA,
    ESTIMATE_FLOORS,
    ESTIMATE_WALLS,
    ESTIMATE_FINISH,
    PROBLEM_TEXT,
    PROJECT_AREA,
    PROJECT_FLOORS,
    PROJECT_WALLS,
    PROJECT_REGION,
    CONSTR_PYROG_TYPE,
    CONSTR_PYROG_REGION,
    CONSTR_PYROG_PRIORITY,
) = range(23)

# ---------- –§–ê–ô–õ–´ –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø ----------

USERS_FILE = "users.json"
CALCS_FILE = "calc_history.json"
PROJECTS_FILE = "projects.json"


def load_users():
    if not os.path.exists(USERS_FILE):
        return set()
    try:
        with open(USERS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return set(data)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å users.json: %s", e)
        return set()


def save_users(users_set):
    try:
        with open(USERS_FILE, "w", encoding="utf-8") as f:
            json.dump(list(users_set), f)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å users.json: %s", e)


def load_calcs():
    if not os.path.exists(CALCS_FILE):
        return {}
    try:
        with open(CALCS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return {str(k): list(v) for k, v in data.items()}
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å calc_history.json: %s", e)
        return {}


def save_calcs(calcs_dict):
    try:
        with open(CALCS_FILE, "w", encoding="utf-8") as f:
            json.dump(calcs_dict, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å calc_history.json: %s", e)


def load_projects():
    if not os.path.exists(PROJECTS_FILE):
        return {}
    try:
        with open(PROJECTS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return data
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å projects.json: %s", e)
        return {}


def save_projects(projects_dict):
    try:
        with open(PROJECTS_FILE, "w", encoding="utf-8") as f:
            json.dump(projects_dict, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å projects.json: %s", e)


known_users = load_users()
calc_history = load_calcs()
projects = load_projects()
telegram_bot = None  # —Å—é–¥–∞ –ø–æ–ª–æ–∂–∏–º bot –∏–∑ Updater

# ---------- –ö–õ–ê–í–ò–ê–¢–£–†–´ ----------

MAIN_KEYBOARD = [
    ["üß± –í—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞", "‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"],
    ["üåç –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞", "ü§ñ –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç"],
    ["üõ† –°–æ–≤–µ—Ç—ã –ø–æ –º–æ–Ω—Ç–∞–∂—É", "üìè –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ö–æ–¥–∞"],
    ["üí∞ –°–º–µ—Ç–∞ –ø–æ –¥–æ–º—É", "üß∫ –°–ø–∏—Å–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤"],
    ["‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ", "üè† –ú–æ–π –¥–æ–º"],
    ["ü•ß –ü–∏—Ä–æ–≥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"],
]

MATERIAL_CATEGORIES = [
    "–§—É–Ω–¥–∞–º–µ–Ω—Ç",
    "–°—Ç–µ–Ω—ã",
    "–ö—Ä–æ–≤–ª—è",
    "–£—Ç–µ–ø–ª–µ–Ω–∏–µ",
    "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞",
    "–§–∞—Å–∞–¥",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

ALL_MATERIALS = [
    "–ì–∞–∑–æ–±–µ—Ç–æ–Ω",
    "–ö–∏—Ä–ø–∏—á",
    "–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫",
    "–ö–∞—Ä–∫–∞—Å",
    "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞",
    "–ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è",
    "–ü—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª",
    "–ú–∏–Ω–≤–∞—Ç–∞",
    "–ü–µ–Ω–æ–ø–ª–µ–∫—Å",
    "–ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω)",
    "–ö–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç",
    "–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ –ø–æ —Å–µ—Ç–∫–µ",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

MONTAGE_LIST = [
    "–ì–∞–∑–æ–±–µ—Ç–æ–Ω",
    "–ö–∏—Ä–ø–∏—á",
    "–ö–∞—Ä–∫–∞—Å",
    "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞",
    "–ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è",
    "–ú–∏–Ω–≤–∞—Ç–∞",
    "–ü–µ–Ω–æ–ø–ª–µ–∫—Å",
    "–ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω)",
    "–ö–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç",
    "–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ –ø–æ —Å–µ—Ç–∫–µ",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

CALC_MATERIALS = [
    "–ö–∏—Ä–ø–∏—á (—à—Ç/–º¬≤)",
    "–ì–∞–∑–æ–±–ª–æ–∫ (—à—Ç/–º¬≤)",
    "–ü–ª–∏—Ç–∫–∞/–∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç (–º¬≤ + –∑–∞–ø–∞—Å)",
    "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å (–º¬≤ + –∑–∞–ø–∞—Å)",
    "–ö–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞ (–¥–ª–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞)",
    "–°—Ç—è–∂–∫–∞ –ø–æ–ª–∞ (–º¬≥ –±–µ—Ç–æ–Ω–∞)",
    "–ö—Ä–∞—Å–∫–∞ (–ª–∏—Ç—Ä—ã)",
    "–õ–µ—Å—Ç–Ω–∏—Ü–∞ (–∫–æ–ª-–≤–æ —Å—Ç—É–ø–µ–Ω–µ–π)",
    "–ó–∞–±–æ—Ä (—Å—Ç–æ–ª–±—ã/–±–µ—Ç–æ–Ω/–æ–±—à–∏–≤–∫–∞)",
    "–ö—Ä–æ–≤–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

ESTIMATE_WALL_OPTIONS = [
    "–ö–∞—Ä–∫–∞—Å",
    "–ì–∞–∑–æ–±–µ—Ç–æ–Ω",
    "–ö–∏—Ä–ø–∏—á",
    "–î—Ä—É–≥–æ–µ (—Å—Ä–µ–¥–Ω–µ–µ)",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

ESTIMATE_FINISH_OPTIONS = [
    "–ö–æ—Ä–æ–±–∫–∞",
    "–ß–µ—Ä–Ω–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞",
    "–ü–æ–¥ –∫–ª—é—á",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

PYROG_TYPES = [
    "–ü–æ–ª –ø–æ –≥—Ä—É–Ω—Ç—É",
    "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ",
    "–ü–ª–æ—Å–∫–∞—è –∫—Ä–æ–≤–ª—è",
    "–ú–∞–Ω—Å–∞—Ä–¥–∞",
    "–ù–∞—Ä—É–∂–Ω–∞—è —Å—Ç–µ–Ω–∞",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]

PYROG_PRIORITIES = [
    "–î—ë—à–µ–≤–æ",
    "–ë–∞–ª–∞–Ω—Å",
    "–î–æ–ª–≥–æ–≤–µ—á–Ω–æ",
    "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
]


# ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ö–õ–ê–í–ò–ê–¢–£–†–´ ----------

def main_menu_keyboard():
    return ReplyKeyboardMarkup(MAIN_KEYBOARD, resize_keyboard=True)


def materials_keyboard(options):
    rows = []
    row = []
    for i, item in enumerate(options, start=1):
        row.append(item)
        if i % 2 == 0:
            rows.append(row)
            row = []
    if row:
        rows.append(row)
    return ReplyKeyboardMarkup(rows, resize_keyboard=True)


# ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –•–†–ê–ù–ï–ù–ò–Ø ----------

def remember_user(chat_id: int):
    if chat_id not in known_users:
        known_users.add(chat_id)
        save_users(known_users)
        logger.info("–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %s (–≤—Å–µ–≥–æ %s)", chat_id, len(known_users))


def remember_calc(chat_id: int, text: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞—Å—á—ë—Ç–∞/–ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    key = str(chat_id)
    history = calc_history.get(key, [])
    history.append(text)
    if len(history) > 50:
        history = history[-50:]
    calc_history[key] = history
    save_calcs(calc_history)


def save_project(chat_id: int, data: dict):
    key = str(chat_id)
    projects[key] = data
    save_projects(projects)


def get_project(chat_id: int):
    return projects.get(str(chat_id))


# ---------- –°–ü–†–ê–í–û–ß–ù–ò–ö–ò, –°–†–ê–í–ù–ï–ù–ò–Ø, –ú–û–ù–¢–ê–ñ ----------

def describe_material_category(category: str) -> str:
    if category == "–§—É–Ω–¥–∞–º–µ–Ω—Ç":
        return (
            "üîπ –§—É–Ω–¥–∞–º–µ–Ω—Ç\n"
            "‚Ä¢ –õ–µ–Ω—Ç–∞ –ñ–ë ‚Äî –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –≥—Ä—É–Ω—Ç–∞—Ö.\n"
            "‚Ä¢ –ü–ª–∏—Ç–∞ ‚Äî –ø—Ä–∏ —Å–ª–∞–±—ã—Ö, –ø—É—á–∏–Ω–∏—Å—Ç—ã—Ö –≥—Ä—É–Ω—Ç–∞—Ö –∏ –≤—ã—Å–æ–∫–∏—Ö –≥—Ä—É–Ω—Ç–æ–≤—ã—Ö –≤–æ–¥–∞—Ö.\n"
            "‚Ä¢ –°–≤–∞–∏ —Å —Ä–æ—Å—Ç–≤–µ—Ä–∫–æ–º ‚Äî –ø—Ä–∏ –ø–µ—Ä–µ–ø–∞–¥–∞—Ö –≤—ã—Å–æ—Ç –∏ —Å–ª–∞–±—ã—Ö –≥—Ä—É–Ω—Ç–∞—Ö.\n\n"
            "‚ùó –õ—é–±–æ–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Ä–∞—Å—á—ë—Ç–∞ —É –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ –°–ü/–°–ù–∏–ü."
        )
    if category == "–°—Ç–µ–Ω—ã":
        return (
            "üîπ –°—Ç–µ–Ω—ã\n"
            "‚Ä¢ –ì–∞–∑–æ–±–µ—Ç–æ–Ω D400‚ÄìD500 ‚Äî —Ç—ë–ø–ª—ã–π, –ª—ë–≥–∫–∏–π, –±—ã—Å—Ç—Ä–æ –≤–æ–∑–≤–æ–¥–∏—Ç—Å—è.\n"
            "‚Ä¢ –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ ‚Äî —Ç—ë–ø–ª—ã–π –∏ –ø—Ä–æ—á–Ω—ã–π, –Ω–æ –¥–æ—Ä–æ–∂–µ.\n"
            "‚Ä¢ –ö–∏—Ä–ø–∏—á ‚Äî –¥–æ–ª–≥–æ–≤–µ—á–Ω—ã–π, –Ω–æ —Ö–æ–ª–æ–¥–Ω—ã–π, –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —Å —É—Ç–µ–ø–ª–µ–Ω–∏–µ–º.\n"
            "‚Ä¢ –ö–∞—Ä–∫–∞—Å ‚Äî –±—ã—Å—Ç—Ä–æ –∏ –≤—ã–≥–æ–¥–Ω–æ, –Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ —Å–±–æ—Ä–∫–∏."
        )
    if category == "–ö—Ä–æ–≤–ª—è":
        return (
            "üîπ –ö—Ä–æ–≤–ª—è\n"
            "‚Ä¢ –ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞ ‚Äî –±—é–¥–∂–µ—Ç–Ω–æ, –Ω–æ —à—É–º–Ω–æ.\n"
            "‚Ä¢ –ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è ‚Äî —Ç–∏—à–µ, –º–µ–Ω—å—à–µ –æ—Ç—Ö–æ–¥–æ–≤ –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö –∫—Ä—ã—à–∞—Ö.\n"
            "‚Ä¢ –ü—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª ‚Äî —á–∞—â–µ –¥–ª—è —Ö–æ–∑–ø–æ—Å—Ç—Ä–æ–µ–∫.\n"
            "–ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∏—Ä–æ–≥ –∏ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è."
        )
    if category == "–£—Ç–µ–ø–ª–µ–Ω–∏–µ":
        return (
            "üîπ –£—Ç–µ–ø–ª–µ–Ω–∏–µ\n"
            "‚Ä¢ –ú–∏–Ω–≤–∞—Ç–∞ ‚Äî –Ω–µ–≥–æ—Ä—é—á–∞—è, —Ö–æ—Ä–æ—à–∞—è –∑–≤—É–∫–æ–∏–∑–æ–ª—è—Ü–∏—è.\n"
            "‚Ä¢ –ü–µ–Ω–æ–ø–ª–µ–∫—Å (XPS) ‚Äî –∂—ë—Å—Ç–∫–∏–π, –Ω–µ –≤–ø–∏—Ç—ã–≤–∞–µ—Ç –≤–æ–¥—É, —Ü–æ–∫–æ–ª—å/–ø–ª–∏—Ç–∞.\n"
            "‚Ä¢ –ü–µ–Ω–æ–ø–ª–∞—Å—Ç ‚Äî –±—é–¥–∂–µ—Ç–Ω—ã–π, –Ω–æ —Å–ª–∞–±–µ–µ –ø–æ –ø–æ–∂–∞—Ä–∫–µ.\n"
            "–í–∞–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å –ø–∞—Ä–æ- –∏ –≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—é."
        )
    if category == "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞":
        return (
            "üîπ –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞\n"
            "‚Ä¢ –ì–ö–õ ‚Äî –±—ã—Å—Ç—Ä–æ –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Å—Ç–µ–Ω—ã –∏ –ø–æ—Ç–æ–ª–∫–∏.\n"
            "‚Ä¢ –®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ ‚Äî –ø—Ä–æ—á–Ω–µ–µ, –ª—É—á—à–µ –≤ –º–æ–∫—Ä—ã—Ö –∑–æ–Ω–∞—Ö.\n"
            "‚Ä¢ –í —Å–∞–Ω—É–∑–ª–∞—Ö ‚Äî –≤–ª–∞–≥–æ—Å—Ç–æ–π–∫–∏–π –ì–ö–õ + –≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è + –ø–ª–∏—Ç–∫–∞."
        )
    if category == "–§–∞—Å–∞–¥":
        return (
            "üîπ –§–∞—Å–∞–¥\n"
            "‚Ä¢ –í–µ–Ω—Ç–∏–ª–∏—Ä—É–µ–º—ã–π ‚Äî –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–∞.\n"
            "‚Ä¢ –ú–æ–∫—Ä—ã–π —Ñ–∞—Å–∞–¥ ‚Äî –¥–µ—à–µ–≤–ª–µ, –Ω–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –∫–∞—á–µ—Å—Ç–≤—É —Ä–∞–±–æ—Ç.\n"
            "‚Ä¢ –û–±–ª–∏—Ü–æ–≤–æ—á–Ω—ã–π –∫–∏—Ä–ø–∏—á ‚Äî –∫—Ä–∞—Å–∏–≤–æ –∏ –Ω–∞–¥–æ–ª–≥–æ, –Ω–æ –¥–æ—Ä–æ–∂–µ."
        )
    return "–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."


def compare_two(material1: str, material2: str) -> str:
    pair = {material1, material2}

    if pair == {"–ì–∞–∑–æ–±–µ—Ç–æ–Ω", "–ö–∏—Ä–ø–∏—á"}:
        return (
            "‚öñÔ∏è –ì–∞–∑–æ–±–µ—Ç–æ–Ω vs –ö–∏—Ä–ø–∏—á\n\n"
            "–ì–∞–∑–æ–±–µ—Ç–æ–Ω:\n"
            "‚Ä¢ –¢—ë–ø–ª—ã–π, –ª—ë–≥–∫–∏–π, –±—ã—Å—Ç—Ä–æ –≤–æ–∑–≤–æ–¥–∏—Ç—Å—è.\n"
            "‚Ä¢ –î–µ—à–µ–≤–ª–µ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É –∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—É.\n"
            "‚Ä¢ –¢—Ä–µ–±—É–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –≤–ª–∞–≥–∏.\n\n"
            "–ö–∏—Ä–ø–∏—á:\n"
            "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ –∂—ë—Å—Ç–∫–æ—Å—Ç—å.\n"
            "‚Ä¢ –•–æ–ª–æ–¥–Ω–µ–µ, –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —Å –¥–æ–ø. —É—Ç–µ–ø–ª–µ–Ω–∏–µ–º.\n"
            "‚Ä¢ –¢—è–∂–µ–ª–µ–µ –∏ –¥–æ—Ä–æ–∂–µ –ø–æ —Ä–∞–±–æ—Ç–µ –∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—É.\n"
        )

    if pair == {"–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞", "–ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è"}:
        return (
            "‚öñÔ∏è –ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞ vs –ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è\n\n"
            "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞ ‚Äî –¥–µ—à–µ–≤–ª–µ –∏ –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —à—É–º–Ω–µ–µ.\n"
            "–ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è ‚Äî —Ç–∏—à–µ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ, –Ω–æ –Ω—É–∂–Ω–∞ —Å–ø–ª–æ—à–Ω–∞—è –æ—Å–Ω–æ–≤–∞ –∏ –¥–æ—Ä–æ–∂–µ —Å–∏—Å—Ç–µ–º–∞.\n"
        )

    if pair == {"–ú–∏–Ω–≤–∞—Ç–∞", "–ü–µ–Ω–æ–ø–ª–µ–∫—Å"}:
        return (
            "‚öñÔ∏è –ú–∏–Ω–≤–∞—Ç–∞ vs –ü–µ–Ω–æ–ø–ª–µ–∫—Å\n\n"
            "–ú–∏–Ω–≤–∞—Ç–∞ ‚Äî –Ω–µ–≥–æ—Ä—é—á–∞—è, —Ö–æ—Ä–æ—à–∞—è –ø–æ –∑–≤—É–∫—É, –∏–¥–µ–∞–ª—å–Ω–∞ –¥–ª—è —Å—Ç–µ–Ω –∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π.\n"
            "–ü–µ–Ω–æ–ø–ª–µ–∫—Å ‚Äî –Ω–µ –≤–ø–∏—Ç—ã–≤–∞–µ—Ç –≤–æ–¥—É, —Ö–æ—Ä–æ—à–æ –¥–ª—è —Ü–æ–∫–æ–ª—è, –ø–ª–∏—Ç –∏ —Å—Ç—è–∂–µ–∫.\n"
        )

    return (
        f"–ü–æ–¥—Ä–æ–±–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–∞—Ä—ã {material1} –∏ {material2} –Ω–µ—Ç.\n"
        "–°–º–æ—Ç—Ä–∏ –Ω–∞ —Ü–µ–Ω—É –∑–∞ –º¬≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Å—Ä–æ–∫ —Å–ª—É–∂–±—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–æ–Ω—Ç–∞–∂–∞."
    )


def montage_tips(material: str) -> str:
    tips = {
        "–ì–∞–∑–æ–±–µ—Ç–æ–Ω": (
            "üõ† –ú–æ–Ω—Ç–∞–∂ –≥–∞–∑–æ–±–µ—Ç–æ–Ω–∞\n"
            "‚Ä¢ 1-–π —Ä—è–¥ ‚Äî –Ω–∞ —Ä–∞—Å—Ç–≤–æ—Ä, –¥–∞–ª—å—à–µ ‚Äî –Ω–∞ –∫–ª–µ–π 2‚Äì3 –º–º.\n"
            "‚Ä¢ –ê—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ 3‚Äì4 —Ä—è–¥–∞ –∏ –Ω–∞–¥ –ø—Ä–æ—ë–º–∞–º–∏.\n"
            "‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –≤–ª–∞–≥–∏ (—Ñ–∞—Å–∞–¥, –æ—Ç–∫–æ—Å—ã, —Ü–æ–∫–æ–ª—å)."
        ),
        "–ö–∏—Ä–ø–∏—á": (
            "üõ† –ö–ª–∞–¥–∫–∞ –∫–∏—Ä–ø–∏—á–∞\n"
            "‚Ä¢ –®–æ–≤ 10‚Äì12 –º–º, –ø–µ—Ä–µ–≤—è–∑–∫–∞ —à–≤–æ–≤.\n"
            "‚Ä¢ –ü—Ä–∏ –æ–±–ª–∏—Ü–æ–≤–∫–µ ‚Äî –≤–µ–Ω—Ç–∑–∞–∑–æ—Ä –∏ –ø—Ä–æ–¥—É—Ö–∏.\n"
            "‚Ä¢ –ù–µ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –º–æ—Ä–æ–∑—É –±–µ–∑ –¥–æ–±–∞–≤–æ–∫."
        ),
        "–ö–∞—Ä–∫–∞—Å": (
            "üõ† –ö–∞—Ä–∫–∞—Å\n"
            "‚Ä¢ –°—É—Ö–∞—è –¥–æ—Å–∫–∞, –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫.\n"
            "‚Ä¢ –®–∞–≥ —Å—Ç–æ–µ–∫ –ø–æ–¥ —É—Ç–µ–ø–ª–∏—Ç–µ–ª—å (–æ–±—ã—á–Ω–æ 600 –º–º).\n"
            "‚Ä¢ –ò–∑–Ω—É—Ç—Ä–∏ ‚Äî –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è, —Å–Ω–∞—Ä—É–∂–∏ ‚Äî –≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–∞ + –≤–µ–Ω—Ç–∑–∞–∑–æ—Ä."
        ),
        "–ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞": (
            "üõ† –ú–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞\n"
            "‚Ä¢ –ì–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è –ø–æ–¥ –∫—Ä–æ–≤–ª–µ–π, –≤–µ–Ω—Ç–∑–∞–∑–æ—Ä.\n"
            "‚Ä¢ –†–µ–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–∂–Ω–∏—Ü–∞–º–∏, –Ω–µ –±–æ–ª–≥–∞—Ä–∫–æ–π.\n"
            "‚Ä¢ –°–∞–º–æ—Ä–µ–∑—ã –∫—Ä—É—Ç–∏—Ç—å –ø–æ —Å—Ö–µ–º–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è."
        ),
        "–ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è": (
            "üõ† –ú—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è\n"
            "‚Ä¢ –°–ø–ª–æ—à–Ω–∞—è –æ—Å–Ω–æ–≤–∞ (–û–°–ü/—Ñ–∞–Ω–µ—Ä–∞).\n"
            "‚Ä¢ –ü–æ–¥–∫–ª–∞–¥–æ—á–Ω—ã–π –∫–æ–≤–µ—Ä –ø–æ –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏.\n"
            "‚Ä¢ –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –µ–Ω–¥–æ–≤–∞–º –∏ –∫–æ–Ω—å–∫—É."
        ),
        "–ú–∏–Ω–≤–∞—Ç–∞": (
            "üõ† –ú–∏–Ω–≤–∞—Ç–∞\n"
            "‚Ä¢ –ü–ª–æ—Ç–Ω–æ–µ –ø—Ä–∏–ª–µ–≥–∞–Ω–∏–µ –±–µ–∑ —â–µ–ª–µ–π.\n"
            "‚Ä¢ –ò–∑–Ω—É—Ç—Ä–∏ ‚Äî –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è, —Å–Ω–∞—Ä—É–∂–∏ ‚Äî –≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–∞.\n"
            "‚Ä¢ –ù–µ –¥–æ–ø—É—Å–∫–∞—Ç—å –Ω–∞–º–æ–∫–∞–Ω–∏—è."
        ),
        "–ü–µ–Ω–æ–ø–ª–µ–∫—Å": (
            "üõ† –ü–µ–Ω–æ–ø–ª–µ–∫—Å\n"
            "‚Ä¢ –ö–ª–µ–π + –¥—é–±–µ–ª—è.\n"
            "‚Ä¢ –®–≤—ã –ø—Ä–æ–ø–µ–Ω–∏–≤–∞—Ç—å.\n"
            "‚Ä¢ –î–ª—è —Ñ–∞—Å–∞–¥–∞ ‚Äî —Å–µ—Ç–∫–∞ –∏ –∞—Ä–º–∏—Ä—É—é—â–∏–π —Å–ª–æ–π."
        ),
        "–ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω)": (
            "üõ† –ì–ö–õ\n"
            "‚Ä¢ –ö–∞—Ä–∫–∞—Å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, —à–∞–≥ —Å—Ç–æ–µ–∫ 600 –º–º.\n"
            "‚Ä¢ –í–ª–∞–≥–æ—Å—Ç–æ–π–∫–∏–π –ì–ö–õ –≤ –º–æ–∫—Ä—ã—Ö –∑–æ–Ω–∞—Ö.\n"
            "‚Ä¢ –®–≤—ã ‚Äî —Å–µ—Ä–ø—è–Ω–∫–∞ + —à–ø–∞–∫–ª—ë–≤–∫–∞."
        ),
        "–ö–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç": (
            "üõ† –ö–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç\n"
            "‚Ä¢ –†–æ–≤–Ω–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ, –≥—Ä—É–Ω—Ç–æ–≤–∫–∞.\n"
            "‚Ä¢ –ö–ª–µ–π –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç, –°–í–ü.\n"
            "‚Ä¢ –ó–∞—Ç–∏—Ä–∫–∞ –ø–æ—Å–ª–µ –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –∫–ª–µ–µ–º."
        ),
        "–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ –ø–æ —Å–µ—Ç–∫–µ": (
            "üõ† –®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ –ø–æ —Å–µ—Ç–∫–µ\n"
            "‚Ä¢ –ì—Ä—É–Ω—Ç–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è.\n"
            "‚Ä¢ –°–µ—Ç–∫—É —Ç–æ–ø–∏—Ç—å –≤ –ø–µ—Ä–≤—ã–π —Å–ª–æ–π.\n"
            "‚Ä¢ –ó–∞—â–∏—â–∞—Ç—å –æ—Ç –ø–µ—Ä–µ—Å—É—à–∏–≤–∞–Ω–∏—è –∏ —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤."
        ),
    }
    return tips.get(material, "–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É.")


def calc_consumption(material_type: str, area: float) -> str:
    if material_type.startswith("–ö–∏—Ä–ø–∏—á"):
        bricks_per_m2 = 60
        total = bricks_per_m2 * area
        return (
            "üìè –ö–∏—Ä–ø–∏—á –ø–æ –ø–ª–æ—â–∞–¥–∏\n"
            f"–ü–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤ ‚Üí ~{total:.0f} –∫–∏—Ä–ø–∏—á–µ–π + 5‚Äì10% –∑–∞–ø–∞—Å–∞."
        )
    if material_type.startswith("–ì–∞–∑–æ–±–ª–æ–∫"):
        blocks_per_m2 = 8
        total = blocks_per_m2 * area
        return (
            "üìè –ì–∞–∑–æ–±–ª–æ–∫ –ø–æ –ø–ª–æ—â–∞–¥–∏\n"
            f"–ü–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤ ‚Üí ~{total:.0f} –±–ª–æ–∫–æ–≤ + 5‚Äì7% –∑–∞–ø–∞—Å–∞."
        )
    if material_type.startswith("–ü–ª–∏—Ç–∫–∞"):
        total = area * 1.1
        return (
            "üìè –ü–ª–∏—Ç–∫–∞ / –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç\n"
            f"–ß–∏—Å—Ç–∞—è –ø–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤ ‚Üí —Å 10% –∑–∞–ø–∞—Å–æ–º: {total:.2f} –º¬≤."
        )
    if material_type.startswith("–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å"):
        total = area * 1.05
        return (
            "üìè –£—Ç–µ–ø–ª–∏—Ç–µ–ª—å\n"
            f"–ß–∏—Å—Ç–∞—è –ø–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤ ‚Üí —Å 5% –∑–∞–ø–∞—Å–æ–º: {total:.2f} –º¬≤."
        )
    return "–ù–µ —Å–º–æ–≥ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞."


# ---------- –°–ú–ï–¢–ê ----------

def fmt_rub(x: float) -> str:
    return f"{int(x):,}".replace(",", " ")


def calc_house_estimate(area: float, floors: int, wall_type: str, finish: str) -> str:
    base_per_m2 = {
        "–ö–∞—Ä–∫–∞—Å": 25000,
        "–ì–∞–∑–æ–±–µ—Ç–æ–Ω": 35000,
        "–ö–∏—Ä–ø–∏—á": 45000,
        "–î—Ä—É–≥–æ–µ (—Å—Ä–µ–¥–Ω–µ–µ)": 30000,
    }.get(wall_type, 30000)

    finish_mult = {
        "–ö–æ—Ä–æ–±–∫–∞": 0.7,
        "–ß–µ—Ä–Ω–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞": 1.0,
        "–ü–æ–¥ –∫–ª—é—á": 1.3,
    }.get(finish, 1.0)

    total = area * floors * base_per_m2 * finish_mult

    parts_share = {
        "–§—É–Ω–¥–∞–º–µ–Ω—Ç": 0.15,
        "–°—Ç–µ–Ω—ã –∏ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–∫–∏": 0.25,
        "–ö—Ä–æ–≤–ª—è": 0.15,
        "–£—Ç–µ–ø–ª–µ–Ω–∏–µ –∏ —Ñ–∞—Å–∞–¥": 0.10,
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞": 0.20,
        "–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏": 0.15,
    }

    materials_ratio = {
        "–§—É–Ω–¥–∞–º–µ–Ω—Ç": 0.45,
        "–°—Ç–µ–Ω—ã –∏ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–∫–∏": 0.55,
        "–ö—Ä–æ–≤–ª—è": 0.50,
        "–£—Ç–µ–ø–ª–µ–Ω–∏–µ –∏ —Ñ–∞—Å–∞–¥": 0.60,
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞": 0.40,
        "–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏": 0.35,
    }

    lines = []
    total_materials = 0.0
    total_work = 0.0

    for name, share in parts_share.items():
        section_total = total * share
        m_ratio = materials_ratio.get(name, 0.5)
        section_materials = section_total * m_ratio
        section_work = section_total - section_materials

        total_materials += section_materials
        total_work += section_work

        lines.append(
            f"{name}: ~{fmt_rub(section_total)} ‚ÇΩ "
            f"(–º–∞—Ç–µ—Ä–∏–∞–ª—ã ~{fmt_rub(section_materials)} ‚ÇΩ, "
            f"—Ä–∞–±–æ—Ç–∞ ~{fmt_rub(section_work)} ‚ÇΩ)"
        )

    table = "\n".join(lines)

    text = (
        "üí∞ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å–º–µ—Ç–∞ –ø–æ –¥–æ–º—É\n\n"
        f"–ü–ª–æ—â–∞–¥—å: {area:.1f} –º¬≤\n"
        f"–≠—Ç–∞–∂–Ω–æ—Å—Ç—å: {floors}\n"
        f"–¢–∏–ø —Å—Ç–µ–Ω: {wall_type}\n"
        f"–£—Ä–æ–≤–µ–Ω—å –æ—Ç–¥–µ–ª–∫–∏: {finish}\n\n"
        "üîπ –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (–º–∞—Ç–µ—Ä–∏–∞–ª—ã + —Ä–∞–±–æ—Ç–∞):\n"
        f"{table}\n\n"
        f"–ò–¢–û–ì–û –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ~{fmt_rub(total_materials)} ‚ÇΩ\n"
        f"–ò–¢–û–ì–û —Ä–∞–±–æ—Ç–∞: ~{fmt_rub(total_work)} ‚ÇΩ\n"
        f"–ò–¢–û–ì–û –ø–æ –¥–æ–º—É: ~{fmt_rub(total)} ‚ÇΩ\n\n"
        "‚ö† –≠—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É —Ä—ã–Ω–∫—É.\n"
        "–¢–æ—á–Ω—É—é —Å–º–µ—Ç—É –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–æ–µ–∫—Ç—É –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ü–µ–Ω–∞–º."
    )
    return text


# ---------- –ë–ê–ó–û–í–´–ï –ü–ò–†–û–ì–ò (–ù–ê –°–õ–£–ß–ê–ô –ë–ï–ó –ò–ò) ----------

def basic_pirog(constr_type: str, region: str, priority: str) -> str:
    """–ü—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω –ø–∏—Ä–æ–≥–∞, –µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è."""
    prio_note = {
        "–î—ë—à–µ–≤–æ": "–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, –Ω–æ —á—É—Ç—å —Å–ª–∞–±–µ–µ –ø–æ –∫–æ–º—Ñ–æ—Ä—Ç—É –∏ —Ä–µ—Å—É—Ä—Å—É",
        "–ë–∞–ª–∞–Ω—Å": "–∫–æ–º–ø—Ä–æ–º–∏—Å—Å –ø–æ —Ü–µ–Ω–µ –∏ –∫–æ–º—Ñ–æ—Ä—Ç—É",
        "–î–æ–ª–≥–æ–≤–µ—á–Ω–æ": "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç, –¥–æ—Ä–æ–∂–µ",
    }.get(priority, "–±–∞–ª–∞–Ω—Å —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ")

    # –¢–æ–ª—â–∏–Ω–∞ —É—Ç–µ–ø–ª–∏—Ç–µ–ª—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–æ–±—â–∏–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä)
    base_th = {"–î—ë—à–µ–≤–æ": 50, "–ë–∞–ª–∞–Ω—Å": 100, "–î–æ–ª–≥–æ–≤–µ—á–Ω–æ": 150}.get(priority, 100)

    if constr_type == "–ü–æ–ª –ø–æ –≥—Ä—É–Ω—Ç—É":
        return (
            f"–ü–∏—Ä–æ–≥: –ø–æ–ª –ø–æ –≥—Ä—É–Ω—Ç—É ({region}, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}, {prio_note})\n\n"
            "–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö:\n"
            "1) –£–ø–ª–æ—Ç–Ω—ë–Ω–Ω—ã–π –≥—Ä—É–Ω—Ç.\n"
            "2) –ü–µ—Å—á–∞–Ω–∞—è –ø–æ–¥—É—à–∫–∞ 100‚Äì150 –º–º —Å –ø—Ä–æ–ª–∏–≤–∫–æ–π.\n"
            "3) –©–µ–±–µ–Ω—å 100‚Äì150 –º–º.\n"
            "4) –ß–µ—Ä–Ω–æ–≤–∞—è —Å—Ç—è–∂–∫–∞ 50‚Äì70 –º–º (–ø–æ –∂–µ–ª–∞–Ω–∏—é).\n"
            f"5) –£—Ç–µ–ø–ª–∏—Ç–µ–ª—å XPS/–º–∏–Ω–ø–ª–∏—Ç–∞ ~{base_th} –º–º.\n"
            "6) –ü–æ–ª–∏—ç—Ç–∏–ª–µ–Ω/–≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è –ø–æ —É—Ç–µ–ø–ª–∏—Ç–µ–ª—é (–≥–µ—Ä–º–µ—Ç–∏—á–Ω–æ –ø–æ —à–≤–∞–º).\n"
            "7) –ß–∏—Å—Ç–æ–≤–∞—è —Å—Ç—è–∂–∫–∞ 60‚Äì80 –º–º —Å –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º.\n"
            "8) –§–∏–Ω–∏—à–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (–ø–ª–∏—Ç–∫–∞/–ª–∞–º–∏–Ω–∞—Ç/–Ω–∞–ª–∏–≤–Ω–æ–π –ø–æ–ª).\n\n"
            "–í–∞–∂–Ω–æ: –æ—Ç—Å–µ—á–Ω–∞—è –≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è –ø–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—É, –¥–µ–º–ø—Ñ–µ—Ä–Ω–∞—è –ª–µ–Ω—Ç–∞ –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É, "
            "—É—á—ë—Ç –≤—ã—Å–æ—Ç—ã —á–∏—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–≤–µ—Ä–µ–π –∏ –ª–µ—Å—Ç–Ω–∏—Ü."
        )

    if constr_type == "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ":
        return (
            f"–ü–∏—Ä–æ–≥: –º–µ–∂—ç—Ç–∞–∂–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ ({region}, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}, {prio_note})\n\n"
            "–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (–ø–æ –±–∞–ª–∫–∞–º/–ø–ª–∏—Ç–µ):\n"
            "1) –ß–µ—Ä–Ω–æ–≤–æ–π –ø–æ—Ç–æ–ª–æ–∫ (–ì–ö–õ/–ø–æ–¥—à–∏–≤–∫–∞).\n"
            f"2) –ó–≤—É–∫–æ-/—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –±–∞–ª–∫–∞–º–∏ ~{base_th} –º–º.\n"
            "3) –ñ—ë—Å—Ç–∫–∏–π –Ω–∞—Å—Ç–∏–ª (–û–°–ü/—Ñ–∞–Ω–µ—Ä–∞ –∏–ª–∏ —Å—Ç—è–∂–∫–∞ –ø–æ –ø–ª–∏—Ç–µ).\n"
            "4) –ü–æ–¥–ª–æ–∂–∫–∞.\n"
            "5) –§–∏–Ω–∏—à–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (–ª–∞–º–∏–Ω–∞—Ç/–ø–∞—Ä–∫–µ—Ç/–ø–ª–∏—Ç–∫–∞).\n\n"
            "–í–∞–∂–Ω–æ: –Ω–µ –ø—É—Ç–∞—Ç—å –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—é –∏ –≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç—É, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∏–º—ã–∫–∞–Ω–∏—è –∫ —Å—Ç–µ–Ω–∞–º."
        )

    if constr_type == "–ü–ª–æ—Å–∫–∞—è –∫—Ä–æ–≤–ª—è":
        return (
            f"–ü–∏—Ä–æ–≥: –ø–ª–æ—Å–∫–∞—è –∫—Ä–æ–≤–ª—è ({region}, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}, {prio_note})\n\n"
            "–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö:\n"
            "1) –û—Å–Ω–æ–≤–∞–Ω–∏–µ (–ø–ª–∏—Ç–∞/–ø—Ä–æ—Ñ–ª–∏—Å—Ç).\n"
            "2) –ü–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è –ø–æ –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ —Å –ø—Ä–æ–∫–ª–µ–π–∫–æ–π —à–≤–æ–≤.\n"
            f"3) –£—Ç–µ–ø–ª–∏—Ç–µ–ª—å (–æ–±—ã—á–Ω–æ XPS/–∫–∞–º–≤–∞—Ç–∞) —Å—É–º–º–∞—Ä–Ω–æ ~{base_th + 50} –º–º.\n"
            "4) –†–∞–∑—É–∫–ª–æ–Ω–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —É–∫–ª–æ–Ω –∫ –≤–æ—Ä–æ–Ω–∫–∞–º).\n"
            "5) –°—Ç—è–∂–∫–∞/–∂—ë—Å—Ç–∫–∏–π –Ω–∞—Å—Ç–∏–ª.\n"
            "6) –ì–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–≤–µ—Ä (–ü–í–•/–¢–ü–û/—Ä—É–ª–æ–Ω–Ω–∞—è –Ω–∞–ø–ª–∞–≤–ª—è–µ–º–∞—è).\n\n"
            "–ö—Ä–∏—Ç–∏—á–Ω–æ: —É–∫–ª–æ–Ω –∫ –≤–æ—Ä–æ–Ω–∫–∞–º, –∑–∞—â–∏—Ç–∞ —É–∑–ª–æ–≤ –ø—Ä–∏–º—ã–∫–∞–Ω–∏–π, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—Å—Ç–æ–π–Ω–æ–π –≤–æ–¥—ã."
        )

    if constr_type == "–ú–∞–Ω—Å–∞—Ä–¥–∞":
        return (
            f"–ü–∏—Ä–æ–≥: –º–∞–Ω—Å–∞—Ä–¥–Ω–∞—è –∫—Ä–æ–≤–ª—è ({region}, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}, {prio_note})\n\n"
            "–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (–∏–∑–Ω—É—Ç—Ä–∏ –Ω–∞—Ä—É–∂—É):\n"
            "1) –û—Ç–¥–µ–ª–∫–∞ (–ì–ö–õ/–≤–∞–≥–æ–Ω–∫–∞) –ø–æ –æ–±—Ä–µ—à—ë—Ç–∫–µ.\n"
            "2) –ü–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è —Å –ø—Ä–æ–∫–ª–µ–π–∫–æ–π —à–≤–æ–≤.\n"
            f"3) –£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Å—Ç—Ä–æ–ø–∏–ª–∞–º–∏ ~{base_th + 50} –º–º.\n"
            "4) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π —É—Ç–µ–ø–ª–∏—Ç–µ–ª—è –ø–æ–ø–µ—Ä—ë–∫ —Å—Ç—Ä–æ–ø–∏–ª (–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏).\n"
            "5) –í–µ—Ç—Ä–æ–≥–∏–¥—Ä–æ–∑–∞—â–∏—Ç–Ω–∞—è –º–µ–º–±—Ä–∞–Ω–∞.\n"
            "6) –ö–æ–Ω—Ç—Ä–æ–±—Ä–µ—à—ë—Ç–∫–∞ (–≤–µ–Ω—Ç–∑–∞–∑–æ—Ä).\n"
            "7) –û–±—Ä–µ—à—ë—Ç–∫–∞.\n"
            "8) –ö—Ä–æ–≤–µ–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (–º–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞/–º—è–≥–∫–∞—è –∫—Ä–æ–≤–ª—è –∏ —Ç.–¥.).\n\n"
            "–í–∞–∂–Ω–æ: —Å–ø–ª–æ—à–Ω–∞—è –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è –∏–∑–Ω—É—Ç—Ä–∏, –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –≤–µ–Ω—Ç–∑–∞–∑–æ—Ä –æ—Ç –∫–∞—Ä–Ω–∏–∑–∞ –∫ –∫–æ–Ω—å–∫—É."
        )

    if constr_type == "–ù–∞—Ä—É–∂–Ω–∞—è —Å—Ç–µ–Ω–∞":
        return (
            f"–ü–∏—Ä–æ–≥: –Ω–∞—Ä—É–∂–Ω–∞—è —Å—Ç–µ–Ω–∞ ({region}, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}, {prio_note})\n\n"
            "–ò–∑–Ω—É—Ç—Ä–∏ –Ω–∞—Ä—É–∂—É (–ø—Ä–∏–º–µ—Ä –¥–ª—è –≥–∞–∑–æ–±–µ—Ç–æ–Ω–∞/–∫–∞—Ä–∫–∞—Å–∞):\n"
            "1) –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞ (–ì–ö–õ/—à—Ç—É–∫–∞—Ç—É—Ä–∫–∞).\n"
            "2) –ü–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è (–¥–ª—è –∫–∞—Ä–∫–∞—Å–∞) –∏–ª–∏ –ø–∞—Ä–æ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º–∞—è —à—Ç—É–∫–∞—Ç—É—Ä–∫–∞ (–¥–ª—è –≥–∞–∑–æ–±–µ—Ç–æ–Ω–∞).\n"
            f"3) –£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –ø–æ —Å—Ç–æ–π–∫–∞–º/—Å–Ω–∞—Ä—É–∂–∏ ~{base_th} –º–º.\n"
            "4) –í–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–Ω–∞—è –º–µ–º–±—Ä–∞–Ω–∞.\n"
            "5) –í–µ–Ω—Ç–∑–∞–∑–æ—Ä 30‚Äì50 –º–º.\n"
            "6) –§–∞—Å–∞–¥ (—Å–∞–π–¥–∏–Ω–≥/—Ñ–∏–±—Ä–æ—Ü–µ–º–µ–Ω—Ç/–∫–∏—Ä–ø–∏—á –∏ —Ç.–¥.).\n\n"
            "–î–ª—è –∫–∏—Ä–ø–∏—á–∞ –≤–º–µ—Å—Ç–æ —É—Ç–µ–ø–ª–∏—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∫–ª–∞–¥–∫–∞ —Å –≤–æ–∑–¥—É—à–Ω—ã–º –∑–∞–∑–æ—Ä–æ–º.\n"
            "–í–∞–∂–Ω–æ: –Ω–µ —Å—Ç–∞–≤–∏—Ç—å –ø–∞—Ä–æ–Ω–µ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–Ω–∞—Ä—É–∂–∏ —Ç—ë–ø–ª–æ–π —Å—Ç–µ–Ω—ã –±–µ–∑ —Ä–∞—Å—á—ë—Ç–∞ —Ç–æ—á–∫–∏ —Ä–æ—Å—ã."
        )

    return (
        f"–ü–æ–∫–∞ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è —Ç–∏–ø–∞: {constr_type}.\n"
        "–ù–æ –æ–±—â–∏–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî ¬´–∏–∑–Ω—É—Ç—Ä–∏ –ø–∞—Ä–æ–Ω–µ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º–µ–µ, —Å–Ω–∞—Ä—É–∂–∏ –ø–∞—Ä–æ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º–µ–µ¬ª, "
        "—Ç—ë–ø–ª—ã–π —Å–ª–æ–π –±–ª–∏–∂–µ –∫ —Ç—ë–ø–ª–æ–π —Å—Ç–æ—Ä–æ–Ω–µ, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –≥–∏–¥—Ä–æ- –∏ –≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–∞."
    )


# ---------- –ò–ò –ß–ï–†–ï–ó OPENROUTER ----------

def ask_ai(question: str) -> str:
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        return "OPENROUTER_API_KEY –Ω–µ –∑–∞–¥–∞–Ω. –î–æ–±–∞–≤—å –µ–≥–æ –≤ Secrets Replit."

    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json",
        "HTTP-Referer": "https://replit.com/",
        "X-Title": "construction-bot",
    }

    system_prompt = (
        "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä-—Å—Ç—Ä–æ–∏—Ç–µ–ª—å. –û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –ø–æ –ø—É–Ω–∫—Ç–∞–º. "
        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –Ω–µ—Å—É—â–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–π, "
        "—á—Ç–æ –Ω—É–∂–µ–Ω –ø—Ä–æ–µ–∫—Ç –∏ —Ä–∞—Å—á—ë—Ç—ã –ø–æ –°–ü/–°–ù–∏–ü —É –∏–Ω–∂–µ–Ω–µ—Ä–∞."
    )

    payload = {
        "model": "meta-llama/llama-3-70b-instruct",
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": question},
        ],
        "temperature": 0.4,
    }

    try:
        r = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers=headers,
            json=payload,
            timeout=40,
        )
        if r.status_code != 200:
            logger.error("OpenRouter %s: %s", r.status_code, r.text)
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò (–æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞)."
        data = r.json()
        return data["choices"][0]["message"]["content"].strip()
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ OpenRouter: %s", e)
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."


# ---------- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ë–û–¢–ê ----------

def start(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    chat_id = update.effective_chat.id
    remember_user(chat_id)

    proj = get_project(chat_id)
    if proj:
        extra = (
            f"\n\nüìå –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –¥–æ–º: {proj.get('area')} –º¬≤, "
            f"{proj.get('floors')} —ç—Ç., {proj.get('walls')}."
        )
    else:
        extra = ""

    welcome_text = (
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name or '–¥—Ä—É–≥'}! üë∑‚Äç‚ôÇÔ∏è\n\n"
        "–Ø –±–æ—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º.\n"
        "–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–∏—Ä–æ–≥–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã –∏ —Å–º–µ—Ç—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ä–∞–±–æ—Ç—É.\n"
        f"{extra}\n\n"
        "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá"
    )
    update.message.reply_text(welcome_text, reply_markup=main_menu_keyboard())
    return MAIN_MENU


def cancel(update: Update, context: CallbackContext) -> int:
    update.message.reply_text(
        "–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ ‚Äî /start",
        reply_markup=ReplyKeyboardRemove(),
    )
    return ConversationHandler.END


def handle_main_menu(update: Update, context: CallbackContext) -> int:
    text = update.message.text.strip()
    chat_id = update.effective_chat.id
    remember_user(chat_id)

    if text == "üß± –í—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞":
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π:",
            reply_markup=materials_keyboard(MATERIAL_CATEGORIES),
        )
        return MATERIAL_CATEGORY

    if text == "‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤":
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –ø–µ—Ä–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª:",
            reply_markup=materials_keyboard(ALL_MATERIALS),
        )
        return COMPARE_FIRST

    if text == "üåç –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞":
        update.message.reply_text(
            "–í–≤–µ–¥–∏ —Å–≤–æ–π —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥:",
            reply_markup=ReplyKeyboardRemove(),
        )
        return REGION_NAME

    if text == "üõ† –°–æ–≤–µ—Ç—ã –ø–æ –º–æ–Ω—Ç–∞–∂—É":
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª:",
            reply_markup=materials_keyboard(MONTAGE_LIST),
        )
        return MONTAGE_MATERIAL

    if text == "üìè –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ö–æ–¥–∞":
        update.message.reply_text(
            "–ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å?",
            reply_markup=materials_keyboard(CALC_MATERIALS),
        )
        return CALC_MATERIAL

    if text == "ü§ñ –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç":
        update.message.reply_text(
            "–ó–∞–¥–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º:",
            reply_markup=ReplyKeyboardRemove(),
        )
        return AI_QUESTION

    if text == "üí∞ –°–º–µ—Ç–∞ –ø–æ –¥–æ–º—É":
        proj = get_project(chat_id)
        if proj:
            update.message.reply_text(
                "–ù–∞—à—ë–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –¥–æ–º.\n"
                "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —Å—Ä–∞–∑—É –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.\n",
                reply_markup=ReplyKeyboardRemove(),
            )
        update.message.reply_text(
            "–í–≤–µ–¥–∏ –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å –¥–æ–º–∞ –≤ –º¬≤ (–ø—Ä–∏–º–µ—Ä: 120):",
            reply_markup=ReplyKeyboardRemove(),
        )
        return ESTIMATE_AREA

    if text == "üß∫ –°–ø–∏—Å–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤":
        return show_calc_list(update, context)

    if text == "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ":
        update.message.reply_text(
            "–û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:\n"
            "‚Ä¢ –≥–¥–µ –∏–º–µ–Ω–Ω–æ (—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, —Å—Ç–µ–Ω–∞, –∫—Ä–æ–≤–ª—è –∏ —Ç.–¥.)\n"
            "‚Ä¢ —á—Ç–æ –≤–∏–¥–∏—à—å (—Ç—Ä–µ—â–∏–Ω—ã, –ø—Ä–æ—Ç–µ—á–∫–∏, —Å–∫—Ä–∏–ø—ã –∏ —Ç.–ø.)\n"
            "‚Ä¢ –≤–æ–∑—Ä–∞—Å—Ç –¥–æ–º–∞/—ç—Ç–∞–ø —Ä–∞–±–æ—Ç\n\n"
            "‚ö†Ô∏è –ò–ò –¥–∞—Å—Ç —Å–æ–≤–µ—Ç—ã, –Ω–æ —ç—Ç–æ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –≤—ã–µ–∑–¥ –∏–Ω–∂–µ–Ω–µ—Ä–∞.",
            reply_markup=ReplyKeyboardRemove(),
        )
        return PROBLEM_TEXT

    if text == "üè† –ú–æ–π –¥–æ–º":
        proj = get_project(chat_id)
        if proj:
            summary = (
                "–¢–µ–∫—É—â–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç:\n\n"
                f"–ü–ª–æ—â–∞–¥—å: {proj.get('area')} –º¬≤\n"
                f"–≠—Ç–∞–∂–µ–π: {proj.get('floors')}\n"
                f"–°—Ç–µ–Ω—ã: {proj.get('walls')}\n"
                f"–†–µ–≥–∏–æ–Ω: {proj.get('region')}\n\n"
                "–°–µ–π—á–∞—Å –æ–±–Ω–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ ‚Äî –≤–≤–µ–¥–∏ –ø–æ —à–∞–≥–∞–º.\n"
            )
            update.message.reply_text(summary, reply_markup=ReplyKeyboardRemove())
        else:
            update.message.reply_text(
                "–î–∞–≤–∞–π —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–≤–æ–µ–≥–æ –¥–æ–º–∞, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö.\n",
                reply_markup=ReplyKeyboardRemove(),
            )

        update.message.reply_text("1/4. –í–≤–µ–¥–∏ –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å –¥–æ–º–∞ –≤ –º¬≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 120):")
        return PROJECT_AREA

    if text == "ü•ß –ü–∏—Ä–æ–≥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏":
        update.message.reply_text(
            "–ß—Ç–æ –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å?\n–í—ã–±–µ—Ä–∏ —Ç–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:",
            reply_markup=materials_keyboard(PYROG_TYPES),
        )
        return CONSTR_PYROG_TYPE

    update.message.reply_text(
        "–ù–µ –ø–æ–Ω—è–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
        reply_markup=main_menu_keyboard(),
    )
    return MAIN_MENU


def handle_material_category(update, context):
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU
    if text not in MATERIAL_CATEGORIES:
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞.",
            reply_markup=materials_keyboard(MATERIAL_CATEGORIES),
        )
        return MATERIAL_CATEGORY
    update.message.reply_text(describe_material_category(text), reply_markup=main_menu_keyboard())
    return MAIN_MENU


def handle_compare_first(update, context):
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU
    if text not in ALL_MATERIALS:
        update.message.reply_text("–í—ã–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞.", reply_markup=materials_keyboard(ALL_MATERIALS))
        return COMPARE_FIRST
    context.user_data["cmp1"] = text
    update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –≤—Ç–æ—Ä–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª:", reply_markup=materials_keyboard(ALL_MATERIALS))
    return COMPARE_SECOND


def handle_compare_second(update, context):
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU
    if text not in ALL_MATERIALS:
        update.message.reply_text("–í—ã–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞.", reply_markup=materials_keyboard(ALL_MATERIALS))
        return COMPARE_SECOND
    first = context.user_data.get("cmp1")
    if not first or first == text:
        update.message.reply_text("–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏. –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–≤—ã–π.", reply_markup=materials_keyboard(ALL_MATERIALS))
        return COMPARE_FIRST
    update.message.reply_text(compare_two(first, text), reply_markup=main_menu_keyboard())
    context.user_data.pop("cmp1", None)
    return MAIN_MENU


def handle_region_name(update, context):
    context.user_data["region_name"] = update.message.text.strip()
    update.message.reply_text(
        "–û–ø–∏—à–∏ –∫–ª–∏–º–∞—Ç (—Ö–æ–ª–æ–¥–Ω—ã–π, —É–º–µ—Ä–µ–Ω–Ω—ã–π, –∂–∞—Ä–∫–∏–π, –≤–ª–∞–∂–Ω—ã–π, –≤–µ—Ç—Ä–µ–Ω—ã–π):",
        reply_markup=ReplyKeyboardRemove(),
    )
    return REGION_CLIMATE


def handle_region_climate(update, context):
    context.user_data["climate"] = update.message.text.strip()
    update.message.reply_text(
        "–ö–∞–∫–æ–π –≥—Ä—É–Ω—Ç? (–ø–µ—Å–æ–∫, –≥–ª–∏–Ω–∞, —Å—É–≥–ª–∏–Ω–æ–∫, –ø—É—á–∏–Ω–∏—Å—Ç—ã–π, —Å–∫–∞–ª–∞, –Ω–µ –∑–Ω–∞—é)",
        reply_markup=ReplyKeyboardRemove(),
    )
    return REGION_GROUND


def handle_region_ground(update, context):
    ground = update.message.text.strip()
    region = context.user_data.get("region_name", "—Ä–µ–≥–∏–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω")
    climate = context.user_data.get("climate", "–∫–ª–∏–º–∞—Ç –Ω–µ —É–∫–∞–∑–∞–Ω")

    txt = (
        f"üåç –†–µ–≥–∏–æ–Ω: {region}\n–ö–ª–∏–º–∞—Ç: {climate}\n–ì—Ä—É–Ω—Ç: {ground}\n\n"
        "–û–±—â–µ–µ:\n"
        "‚Ä¢ –ì–ª–∏–Ω–∞/–ø—É—á–∏–Ω–∏—Å—Ç—ã–µ + –≤—ã—Å–æ–∫–∏–µ –ì–í ‚Üí —á–∞—â–µ –ø–ª–∏—Ç–∞ –∏–ª–∏ —Å–≤–∞–∏.\n"
        "‚Ä¢ –ü–µ—Å–∫–∏/—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –≥—Ä—É–Ω—Ç—ã ‚Üí –º–æ–∂–Ω–æ –ª–µ–Ω—Ç–æ—á–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç.\n"
        "‚Ä¢ –í —Ö–æ–ª–æ–¥–Ω–æ–º –∫–ª–∏–º–∞—Ç–µ –≤–∞–∂–Ω–∞ —Ç—ë–ø–ª–∞—è —Å—Ç–µ–Ω–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—Ä–æ–≤–ª—è.\n\n"
        "–¢–æ—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ª—É—á—à–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ –ø—Ä–æ–µ–∫—Ç—É –∏ —Ä–∞—Å—á—ë—Ç–∞–º –∏–Ω–∂–µ–Ω–µ—Ä–∞."
    )
    update.message.reply_text(txt, reply_markup=main_menu_keyboard())
    context.user_data.clear()
    return MAIN_MENU


def handle_montage_material(update, context):
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU
    if text not in MONTAGE_LIST:
        update.message.reply_text("–í—ã–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞.", reply_markup=materials_keyboard(MONTAGE_LIST))
        return MONTAGE_MATERIAL
    update.message.reply_text(montage_tips(text), reply_markup=main_menu_keyboard())
    return MAIN_MENU


def handle_calc_material(update, context):
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU

    if text not in CALC_MATERIALS:
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.",
            reply_markup=materials_keyboard(CALC_MATERIALS),
        )
        return CALC_MATERIAL

    context.user_data["calc_material"] = text

    if text in [
        "–ö–∏—Ä–ø–∏—á (—à—Ç/–º¬≤)",
        "–ì–∞–∑–æ–±–ª–æ–∫ (—à—Ç/–º¬≤)",
        "–ü–ª–∏—Ç–∫–∞/–∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç (–º¬≤ + –∑–∞–ø–∞—Å)",
        "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å (–º¬≤ + –∑–∞–ø–∞—Å)",
    ]:
        msg = "–í–≤–µ–¥–∏ –ø–ª–æ—â–∞–¥—å –≤ –º¬≤ (–º–æ–∂–Ω–æ —Å –¥—Ä–æ–±—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä 23.5):"

    elif text == "–ö–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞ (–¥–ª–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞)":
        msg = (
            "–í–≤–µ–¥–∏ –¥–ª–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É —Å—Ç–µ–Ω—ã –≤ –º–µ—Ç—Ä–∞—Ö —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n"
            "–ü—Ä–∏–º–µ—Ä: `10 3` –∏–ª–∏ `10 3 0.38` (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∫–∞–∑–∞—Ç—å —Ç–æ–ª—â–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö)."
        )

    elif text == "–°—Ç—è–∂–∫–∞ –ø–æ–ª–∞ (–º¬≥ –±–µ—Ç–æ–Ω–∞)":
        msg = "–í–≤–µ–¥–∏ –ø–ª–æ—â–∞–¥—å –≤ –º¬≤ –∏ —Ç–æ–ª—â–∏–Ω—É —Å—Ç—è–∂–∫–∏ –≤ —Å–º —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü—Ä–∏–º–µ—Ä: `40 6`."

    elif text == "–ö—Ä–∞—Å–∫–∞ (–ª–∏—Ç—Ä—ã)":
        msg = "–í–≤–µ–¥–∏ –ø–ª–æ—â–∞–¥—å –æ–∫—Ä–∞—à–∏–≤–∞–µ–º–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≤ –º¬≤ (—Å—Ç–µ–Ω—ã + –ø–æ—Ç–æ–ª–æ–∫)."

    elif text == "–õ–µ—Å—Ç–Ω–∏—Ü–∞ (–∫–æ–ª-–≤–æ —Å—Ç—É–ø–µ–Ω–µ–π)":
        msg = (
            "–í–≤–µ–¥–∏ –≤—ã—Å–æ—Ç—É –ø–æ–¥—ä—ë–º–∞ –∏ –∂–µ–ª–∞–µ–º—É—é –≤—ã—Å–æ—Ç—É —Å—Ç—É–ø–µ–Ω–∏ –≤ —Å–º —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n"
            "–ü—Ä–∏–º–µ—Ä: `280 17` (–≤—ã—Å–æ—Ç–∞ –æ—Ç –ø–æ–ª–∞ –¥–æ –ø–æ–ª–∞ –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç—É–ø–µ–Ω–∏)."
        )

    elif text == "–ó–∞–±–æ—Ä (—Å—Ç–æ–ª–±—ã/–±–µ—Ç–æ–Ω/–æ–±—à–∏–≤–∫–∞)":
        msg = (
            "–í–≤–µ–¥–∏ –¥–ª–∏–Ω—É –∑–∞–±–æ—Ä–∞ –≤ –º–µ—Ç—Ä–∞—Ö, —à–∞–≥ —Å—Ç–æ–ª–±–æ–≤ –≤ –º–µ—Ç—Ä–∞—Ö "
            "–∏ –≤—ã—Å–æ—Ç—É –∑–∞–±–æ—Ä–∞ –≤ –º–µ—Ç—Ä–∞—Ö —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n"
            "–ü—Ä–∏–º–µ—Ä: `40 2.5 2`."
        )

    elif text == "–ö—Ä–æ–≤–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã":
        msg = (
            "–í–≤–µ–¥–∏ –ø–ª–æ—â–∞–¥—å –¥–æ–º–∞ –ø–æ –∫–æ–Ω—Ç—É—Ä—É (–ø—Ä–æ–µ–∫—Ü–∏—è –∫—Ä—ã—à–∏) –≤ –º¬≤ "
            "–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–æ–±—ã—á–Ω–æ 1.1‚Äì1.4) —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n"
            "–ü—Ä–∏–º–µ—Ä: `120 1.25`."
        )

    else:
        msg = "–í–≤–µ–¥–∏ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è."

    update.message.reply_text(msg, reply_markup=ReplyKeyboardRemove())
    return CALC_AREA


def handle_calc_area(update, context):
    text = update.message.text.strip().replace(",", ".")
    material_type = context.user_data.get("calc_material")
    chat_id = update.effective_chat.id

    # –ü—Ä–æ—Å—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø–ª–æ—â–∞–¥—å
    if material_type in [
        "–ö–∏—Ä–ø–∏—á (—à—Ç/–º¬≤)",
        "–ì–∞–∑–æ–±–ª–æ–∫ (—à—Ç/–º¬≤)",
        "–ü–ª–∏—Ç–∫–∞/–∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç (–º¬≤ + –∑–∞–ø–∞—Å)",
        "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å (–º¬≤ + –∑–∞–ø–∞—Å)",
    ]:
        try:
            area = float(text)
            if area <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        answer = calc_consumption(material_type, area)
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –ö–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞
    if material_type == "–ö–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞ (–¥–ª–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞)":
        parts = text.split()
        if len(parts) not in (2, 3):
            update.message.reply_text(
                "–ù—É–∂–Ω–æ 2 –∏–ª–∏ 3 —á–∏—Å–ª–∞. –ü—Ä–∏–º–µ—Ä: `10 3` –∏–ª–∏ `10 3 0.38`."
            )
            return CALC_AREA
        try:
            length = float(parts[0])
            height = float(parts[1])
            thickness = float(parts[2]) if len(parts) == 3 else 0.38
            if length <= 0 or height <= 0 or thickness <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        volume = length * height * thickness
        bricks_per_m3 = 400
        bricks = volume * bricks_per_m3
        answer = (
            "üìè –ö–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞\n"
            f"–î–ª–∏–Ω–∞: {length:.2f} –º, –≤—ã—Å–æ—Ç–∞: {height:.2f} –º, —Ç–æ–ª—â–∏–Ω–∞: {thickness:.2f} –º\n"
            f"–û–±—ä—ë–º –∫–ª–∞–¥–∫–∏: {volume:.2f} –º¬≥\n"
            f"–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ: {bricks:.0f} –∫–∏—Ä–ø–∏—á–µ–π (+10% –∑–∞–ø–∞—Å–∞)."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –°—Ç—è–∂–∫–∞ –ø–æ–ª–∞
    if material_type == "–°—Ç—è–∂–∫–∞ –ø–æ–ª–∞ (–º¬≥ –±–µ—Ç–æ–Ω–∞)":
        parts = text.split()
        if len(parts) != 2:
            update.message.reply_text("–ù—É–∂–Ω–æ 2 —á–∏—Å–ª–∞: –ø–ª–æ—â–∞–¥—å –∏ —Ç–æ–ª—â–∏–Ω—É –≤ —Å–º. –ü—Ä–∏–º–µ—Ä: `40 6`.")
            return CALC_AREA
        try:
            area = float(parts[0])
            thickness_cm = float(parts[1])
            if area <= 0 or thickness_cm <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        volume = area * (thickness_cm / 100.0)
        volume_with_margin = volume * 1.1
        answer = (
            "üìè –°—Ç—è–∂–∫–∞ –ø–æ–ª–∞\n"
            f"–ü–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤, —Ç–æ–ª—â–∏–Ω–∞: {thickness_cm:.1f} —Å–º\n"
            f"–ß–∏—Å—Ç—ã–π –æ–±—ä—ë–º: {volume:.2f} –º¬≥\n"
            f"–° –∑–∞–ø–∞—Å–æ–º ~10%: {volume_with_margin:.2f} –º¬≥ –±–µ—Ç–æ–Ω–∞."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –ö—Ä–∞—Å–∫–∞
    if material_type == "–ö—Ä–∞—Å–∫–∞ (–ª–∏—Ç—Ä—ã)":
        try:
            area = float(text)
            if area <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –ø–ª–æ—â–∞–¥—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        consumption_per_m2 = 0.12  # –Ω–∞ 2 —Å–ª–æ—è
        liters = area * consumption_per_m2
        answer = (
            "üìè –ö—Ä–∞—Å–∫–∞\n"
            f"–ü–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤\n"
            f"–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ 2 —Å–ª–æ—è: {liters:.1f} –ª.\n"
            "–¢–æ—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ —Å–º–æ—Ç—Ä–∏ –Ω–∞ –±–∞–Ω–∫–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫—Ä–∞—Å–∫–∏."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –õ–µ—Å—Ç–Ω–∏—Ü–∞
    if material_type == "–õ–µ—Å—Ç–Ω–∏—Ü–∞ (–∫–æ–ª-–≤–æ —Å—Ç—É–ø–µ–Ω–µ–π)":
        parts = text.split()
        if len(parts) != 2:
            update.message.reply_text(
                "–ù—É–∂–Ω–æ 2 —á–∏—Å–ª–∞: –≤—ã—Å–æ—Ç–∞ –ø–æ–¥—ä—ë–º–∞ –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç—É–ø–µ–Ω–∏ –≤ —Å–º. –ü—Ä–∏–º–µ—Ä: `280 17`."
            )
            return CALC_AREA
        try:
            total_height_cm = float(parts[0])
            step_height_cm = float(parts[1])
            if total_height_cm <= 0 or step_height_cm <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        steps = max(1, round(total_height_cm / step_height_cm))
        h = total_height_cm / steps
        tread_depth_cm = max(25.0, min(32.0, 63 - 2 * h))
        stair_length_m = steps * tread_depth_cm / 100.0

        answer = (
            "üßÆ –õ–µ—Å—Ç–Ω–∏—Ü–∞ (–º–∞—Ä—à)\n"
            f"–í—ã—Å–æ—Ç–∞ –ø–æ–¥—ä—ë–º–∞: {total_height_cm:.0f} —Å–º\n"
            f"–ñ–µ–ª–∞–µ–º–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—É–ø–µ–Ω–∏: ~{step_height_cm:.0f} —Å–º\n\n"
            f"–†–∞—Å—á—ë—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–ø–µ–Ω–µ–π: {steps}\n"
            f"–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—É–ø–µ–Ω–∏: ~{h:.1f} —Å–º\n"
            f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —à–∏—Ä–∏–Ω–∞ –ø—Ä–æ—Å—Ç—É–ø–∏: ~{tread_depth_cm:.0f} —Å–º\n"
            f"–ü—Ä–∏–º–µ—Ä–Ω–∞—è –¥–ª–∏–Ω–∞ –º–∞—Ä—à–∞: ~{stair_length_m:.2f} –º.\n\n"
            "–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø–ª–æ—â–∞–¥–∫–∏, —à–∏—Ä–∏–Ω—É –º–∞—Ä—à–∞ –∏ –Ω–æ—Ä–º—ã –°–ü."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –ó–∞–±–æ—Ä
    if material_type == "–ó–∞–±–æ—Ä (—Å—Ç–æ–ª–±—ã/–±–µ—Ç–æ–Ω/–æ–±—à–∏–≤–∫–∞)":
        parts = text.split()
        if len(parts) != 3:
            update.message.reply_text(
                "–ù—É–∂–Ω–æ 3 —á–∏—Å–ª–∞: –¥–ª–∏–Ω–∞ –∑–∞–±–æ—Ä–∞, —à–∞–≥ —Å—Ç–æ–ª–±–æ–≤ –∏ –≤—ã—Å–æ—Ç–∞ –≤ –º–µ—Ç—Ä–∞—Ö.\n"
                "–ü—Ä–∏–º–µ—Ä: `40 2.5 2`."
            )
            return CALC_AREA
        try:
            length = float(parts[0])
            step = float(parts[1])
            height = float(parts[2])
            if length <= 0 or step <= 0 or height <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        posts = int(length // step) + 1
        spans = max(0, posts - 1)
        concrete_per_post = 0.3 * 0.3 * 0.7
        concrete_total = posts * concrete_per_post
        cladding_area = length * height

        answer = (
            "üßÆ –ó–∞–±–æ—Ä\n"
            f"–î–ª–∏–Ω–∞: {length:.1f} –º, —à–∞–≥ —Å—Ç–æ–ª–±–æ–≤: {step:.2f} –º, –≤—ã—Å–æ—Ç–∞: {height:.1f} –º\n\n"
            f"–°—Ç–æ–ª–±–æ–≤: {posts} —à—Ç.\n"
            f"–ü—Ä–æ–ª—ë—Ç–æ–≤: {spans} —à—Ç.\n"
            f"–û–±—ä—ë–º –±–µ—Ç–æ–Ω–∞ –ø–æ–¥ —Å—Ç–æ–ª–±—ã: ~{concrete_total:.2f} –º¬≥.\n"
            f"–ü–ª–æ—â–∞–¥—å –æ–±—à–∏–≤–∫–∏ (—Å–µ—Ç–∫–∞/–ø—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª –∏ —Ç.–ø.): ~{cladding_area:.1f} –º¬≤.\n\n"
            "–£—á—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—ã –Ω–∞ —É–≥–ª–∞—Ö –∏ –≤–æ—Ä–æ—Ç–∞, –∞ —Ç–∞–∫–∂–µ –∑–∞–ø–∞—Å –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É 5‚Äì10%."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    # –ö—Ä–æ–≤–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã
    if material_type == "–ö—Ä–æ–≤–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã":
        parts = text.split()
        if len(parts) != 2:
            update.message.reply_text(
                "–ù—É–∂–Ω–æ 2 —á–∏—Å–ª–∞: –ø–ª–æ—â–∞–¥—å –¥–æ–º–∞ –ø–æ –∫–æ–Ω—Ç—É—Ä—É (–º¬≤) –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.\n"
                "–ü—Ä–∏–º–µ—Ä: `120 1.25`."
            )
            return CALC_AREA
        try:
            base_area = float(parts[0])
            k = float(parts[1])
            if base_area <= 0 or k <= 0:
                raise ValueError
        except ValueError:
            update.message.reply_text("–û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
            return CALC_AREA

        roof_area = base_area * k
        roof_with_waste = roof_area * 1.10

        answer = (
            "üßÆ –ö—Ä–æ–≤–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã\n"
            f"–ü–ª–æ—â–∞–¥—å –ø–æ –∫–æ–Ω—Ç—É—Ä—É: {base_area:.1f} –º¬≤\n"
            f"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {k:.2f}\n\n"
            f"–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Ä–∞–±–æ—á–∞—è –ø–ª–æ—â–∞–¥—å –∫—Ä–æ–≤–ª–∏: ~{roof_area:.1f} –º¬≤\n"
            f"–° —É—á—ë—Ç–æ–º 10% –∑–∞–ø–∞—Å–∞: ~{roof_with_waste:.1f} –º¬≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.\n\n"
            "–¢–æ—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ö–µ–º—ã —Å—Ç—Ä–æ–ø–∏–ª, –µ–Ω–¥–æ–≤, —Å–≤–µ—Å–æ–≤ –∏ —Ç–∏–ø–∞ –ø–æ–∫—Ä—ã—Ç–∏—è."
        )
        remember_calc(chat_id, answer)
        update.message.reply_text(answer, reply_markup=main_menu_keyboard())
        context.user_data.pop("calc_material", None)
        return MAIN_MENU

    update.message.reply_text(
        "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é.",
        reply_markup=main_menu_keyboard(),
    )
    context.user_data.pop("calc_material", None)
    return MAIN_MENU


# ---------- –°–ú–ï–¢–ê: –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ----------

def handle_estimate_area(update: Update, context: CallbackContext) -> int:
    txt = update.message.text.strip().replace(",", ".")
    try:
        area = float(txt)
        if area <= 0:
            raise ValueError
    except ValueError:
        update.message.reply_text("–ù—É–∂–Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –≤ –º¬≤. –ü—Ä–∏–º–µ—Ä: 120")
        return ESTIMATE_AREA

    context.user_data["est_area"] = area
    update.message.reply_text(
        "–°–∫–æ–ª—å–∫–æ —ç—Ç–∞–∂–µ–π —É –¥–æ–º–∞? –í–≤–µ–¥–∏ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 1 –∏–ª–∏ 2.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return ESTIMATE_FLOORS


def handle_estimate_floors(update: Update, context: CallbackContext) -> int:
    txt = update.message.text.strip()
    try:
        floors = int(txt)
        if floors <= 0 or floors > 4:
            raise ValueError
    except ValueError:
        update.message.reply_text("–í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ —ç—Ç–∞–∂–µ–π (1‚Äì4).")
        return ESTIMATE_FLOORS

    context.user_data["est_floors"] = floors
    update.message.reply_text(
        "–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Å—Ç–µ–Ω:",
        reply_markup=materials_keyboard(ESTIMATE_WALL_OPTIONS),
    )
    return ESTIMATE_WALLS


def handle_estimate_walls(update: Update, context: CallbackContext) -> int:
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        context.user_data.pop("est_area", None)
        context.user_data.pop("est_floors", None)
        return MAIN_MENU

    if text not in ESTIMATE_WALL_OPTIONS:
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.",
            reply_markup=materials_keyboard(ESTIMATE_WALL_OPTIONS),
        )
        return ESTIMATE_WALLS

    context.user_data["est_walls"] = text
    update.message.reply_text(
        "–í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å –æ—Ç–¥–µ–ª–∫–∏:",
        reply_markup=materials_keyboard(ESTIMATE_FINISH_OPTIONS),
    )
    return ESTIMATE_FINISH


def handle_estimate_finish(update: Update, context: CallbackContext) -> int:
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–í–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        context.user_data.clear()
        return MAIN_MENU

    if text not in ESTIMATE_FINISH_OPTIONS:
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.",
            reply_markup=materials_keyboard(ESTIMATE_FINISH_OPTIONS),
        )
        return ESTIMATE_FINISH

    area = context.user_data.get("est_area")
    floors = context.user_data.get("est_floors")
    walls = context.user_data.get("est_walls")
    chat_id = update.effective_chat.id

    answer = calc_house_estimate(area, floors, walls, text)
    remember_calc(chat_id, answer)
    update.message.reply_text(answer, reply_markup=main_menu_keyboard())
    context.user_data.clear()
    return MAIN_MENU


# ---------- –ò–ò -----------

def handle_ai_question(update, context):
    question = update.message.text.strip()
    context.bot.send_chat_action(chat_id=update.effective_chat.id, action=ChatAction.TYPING)
    answer = ask_ai(question)
    remember_calc(update.effective_chat.id, answer)
    update.message.reply_text(answer, reply_markup=main_menu_keyboard())
    return MAIN_MENU


def handle_problem_text(update: Update, context: CallbackContext) -> int:
    desc = update.message.text.strip()
    question = (
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ.\n\n"
        f"–û–ø–∏—Å–∞–Ω–∏–µ: {desc}\n\n"
        "–î–∞–π —Ä–∞–∑–±–æ—Ä –ø–æ –ø—É–Ω–∫—Ç–∞–º:\n"
        "1) –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã.\n"
        "2) –ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.\n"
        "3) –ö–æ–≥–¥–∞ —É–∂–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–≤–∞—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä–∞/–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞.\n"
        "–ö—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."
    )
    update.message.chat.send_action(ChatAction.TYPING)
    answer = ask_ai(question)
    remember_calc(update.effective_chat.id, answer)
    update.message.reply_text(answer, reply_markup=main_menu_keyboard())
    return MAIN_MENU


# ---------- –ü–ò–†–û–ì –ö–û–ù–°–¢–†–£–ö–¶–ò–ò ----------

def handle_pirog_type(update: Update, context: CallbackContext) -> int:
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–û–∫, –≤–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return MAIN_MENU

    if text not in PYROG_TYPES:
        update.message.reply_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —Ç–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞.",
            reply_markup=materials_keyboard(PYROG_TYPES),
        )
        return CONSTR_PYROG_TYPE

    context.user_data["pyrog_type"] = text
    update.message.reply_text(
        "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Ä–µ–≥–∏–æ–Ω –∏ –∫—Ä–∞—Ç–∫–æ –∫–ª–∏–º–∞—Ç.\n"
        "–ü—Ä–∏–º–µ—Ä: ¬´–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, —Ö–æ–ª–æ–¥–Ω—ã–π –≤–ª–∞–∂–Ω—ã–π –∫–ª–∏–º–∞—Ç¬ª "
        "–∏–ª–∏ ¬´–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –º—è–≥–∫–∏–π –∫–ª–∏–º–∞—Ç¬ª.",
        reply_markup=ReplyKeyboardRemove(),
    )
    return CONSTR_PYROG_REGION


def handle_pirog_region(update: Update, context: CallbackContext) -> int:
    region = update.message.text.strip()
    context.user_data["pyrog_region"] = region
    update.message.reply_text(
        "–ß—Ç–æ –≤–∞–∂–Ω–æ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ?\n"
        "–í—ã–±–µ—Ä–∏:\n"
        "‚Ä¢ ¬´–î—ë—à–µ–≤–æ¬ª ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å\n"
        "‚Ä¢ ¬´–ë–∞–ª–∞–Ω—Å¬ª ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ\n"
        "‚Ä¢ ¬´–î–æ–ª–≥–æ–≤–µ—á–Ω–æ¬ª ‚Äî —Ä–µ—Å—É—Ä—Å –∏ –∫–æ–º—Ñ–æ—Ä—Ç",
        reply_markup=materials_keyboard(PYROG_PRIORITIES),
    )
    return CONSTR_PYROG_PRIORITY


def handle_pirog_priority(update: Update, context: CallbackContext) -> int:
    text = update.message.text.strip()
    if text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        update.message.reply_text("–û–∫, –≤–æ–∑–≤—Ä–∞—â–∞—é –≤ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        context.user_data.pop("pyrog_type", None)
        context.user_data.pop("pyrog_region", None)
        return MAIN_MENU

    if text not in PYROG_PRIORITIES:
        update.message.reply_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.",
            reply_markup=materials_keyboard(PYROG_PRIORITIES),
        )
        return CONSTR_PYROG_PRIORITY

    constr_type = context.user_data.get("pyrog_type", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    region = context.user_data.get("pyrog_region", "—Ä–µ–≥–∏–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω")
    priority = text
    chat_id = update.effective_chat.id

    # –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
    base = basic_pirog(constr_type, region, priority)

    # –ü–æ–ø—ã—Ç–∫–∞ —Å–ø—Ä–æ—Å–∏—Ç—å –ò–ò (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á)
    api_key = os.getenv("OPENROUTER_API_KEY")
    if api_key:
        prompt = (
            "–ü–æ–¥–±–µ—Ä–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (¬´–ø–∏—Ä–æ–≥¬ª) –¥–ª—è —á–∞—Å—Ç–Ω–æ–≥–æ –¥–æ–º–∞.\n\n"
            f"–≠–ª–µ–º–µ–Ω—Ç: {constr_type}\n"
            f"–†–µ–≥–∏–æ–Ω/–∫–ª–∏–º–∞—Ç: {region}\n"
            f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}\n\n"
            "–ù—É–∂–Ω–æ:\n"
            "‚Ä¢ –î–∞—Ç—å 1‚Äì2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–∏—Ä–æ–≥–∞ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö/–∏–∑–Ω—É—Ç—Ä–∏ –Ω–∞—Ä—É–∂—É.\n"
            "‚Ä¢ –£–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ç–æ–ª—â–∏–Ω—É —É—Ç–µ–ø–ª–∏—Ç–µ–ª—è –≤ –º–º.\n"
            "‚Ä¢ –û—Ç–º–µ—Ç–∏—Ç—å, –≥–¥–µ –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è, –≥–¥–µ –≥–∏–¥—Ä–æ-/–≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–∞.\n"
            "‚Ä¢ –ö—Ä–∞—Ç–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–ª–æ—é.\n"
            "–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, —Å –±—É–ª–ª–µ—Ç–∞–º–∏. –ë–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã."
        )
        update.message.chat.send_action(ChatAction.TYPING)
        ai_answer = ask_ai(prompt)
        text_reply = (
            "üîé –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç –ò–ò:\n\n"
            f"{ai_answer}\n\n"
            "üìå –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∫—É/–æ—Å–Ω–æ–≤—É):\n\n"
            f"{base}"
        )
    else:
        text_reply = (
            "üìå –ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω –ø–∏—Ä–æ–≥–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n\n"
            f"{base}\n\n"
            "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Ç–∞–∫–∂–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç –ò–ò, –¥–æ–±–∞–≤—å –≤ Secrets –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é "
            "OPENROUTER_API_KEY."
        )

    remember_calc(chat_id, text_reply)
    update.message.reply_text(text_reply, reply_markup=main_menu_keyboard())
    context.user_data.pop("pyrog_type", None)
    context.user_data.pop("pyrog_region", None)
    return MAIN_MENU


# ---------- –ú–û–ô –î–û–ú ----------

def handle_project_area(update: Update, context: CallbackContext) -> int:
    txt = update.message.text.strip().replace(",", ".")
    try:
        area = float(txt)
        if area <= 0:
            raise ValueError
    except ValueError:
        update.message.reply_text("–ù—É–∂–Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –≤ –º¬≤. –ü—Ä–∏–º–µ—Ä: 120")
        return PROJECT_AREA

    context.user_data["proj_area"] = area
    update.message.reply_text("2/4. –°–∫–æ–ª—å–∫–æ —ç—Ç–∞–∂–µ–π? –í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (1‚Äì4):")
    return PROJECT_FLOORS


def handle_project_floors(update: Update, context: CallbackContext) -> int:
    txt = update.message.text.strip()
    try:
        floors = int(txt)
        if floors <= 0 or floors > 4:
            raise ValueError
    except ValueError:
        update.message.reply_text("–í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ —ç—Ç–∞–∂–µ–π –æ—Ç 1 –¥–æ 4.")
        return PROJECT_FLOORS

    context.user_data["proj_floors"] = floors
    update.message.reply_text(
        "3/4. –ù–∞–ø–∏—à–∏ —Ç–∏–ø —Å—Ç–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≥–∞–∑–æ–±–µ—Ç–æ–Ω, –∫–∞—Ä–∫–∞—Å, –∫–∏—Ä–ø–∏—á):"
    )
    return PROJECT_WALLS


def handle_project_walls(update: Update, context: CallbackContext) -> int:
    walls = update.message.text.strip()
    if not walls:
        update.message.reply_text("–û–ø–∏—à–∏ —Ç–∏–ø —Å—Ç–µ–Ω, —Ö–æ—Ç—è –±—ã –≤ 1‚Äì2 —Å–ª–æ–≤–∞—Ö.")
        return PROJECT_WALLS

    context.user_data["proj_walls"] = walls
    update.message.reply_text(
        "4/4. –í–≤–µ–¥–∏ —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–¥–ª—è –∫–ª–∏–º–∞—Ç–∞ –∏ –≥—Ä—É–Ω—Ç–æ–≤):"
    )
    return PROJECT_REGION


def handle_project_region(update: Update, context: CallbackContext) -> int:
    region = update.message.text.strip()
    chat_id = update.effective_chat.id

    data = {
        "area": context.user_data.get("proj_area"),
        "floors": context.user_data.get("proj_floors"),
        "walls": context.user_data.get("proj_walls"),
        "region": region,
    }
    save_project(chat_id, data)
    context.user_data.pop("proj_area", None)
    context.user_data.pop("proj_floors", None)
    context.user_data.pop("proj_walls", None)

    summary = (
        "‚úÖ –ü—Ä–æ–µ–∫—Ç –¥–æ–º–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.\n\n"
        f"–ü–ª–æ—â–∞–¥—å: {data['area']} –º¬≤\n"
        f"–≠—Ç–∞–∂–µ–π: {data['floors']}\n"
        f"–°—Ç–µ–Ω—ã: {data['walls']}\n"
        f"–†–µ–≥–∏–æ–Ω: {data['region']}\n\n"
        "–¢–µ–ø–µ—Ä—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–º–µ—Ç—ã –∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò."
    )
    update.message.reply_text(summary, reply_markup=main_menu_keyboard())
    return MAIN_MENU


# ---------- –°–ü–ò–°–û–ö –†–ê–°–ß–Å–¢–û–í / –≠–ö–°–ü–û–†–¢ ----------

def show_calc_list(update: Update, context: CallbackContext) -> int:
    chat_id = update.effective_chat.id
    history = calc_history.get(str(chat_id), [])
    if not history:
        update.message.reply_text(
            "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.\n"
            "–°–¥–µ–ª–∞–π –ª—é–±–æ–π —Ä–∞—Å—á—ë—Ç —á–µ—Ä–µ–∑ üìè –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, üí∞ –°–º–µ—Ç—É –∏–ª–∏ ü•ß –ü–∏—Ä–æ–≥ ‚Äî –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
            reply_markup=main_menu_keyboard(),
        )
        return MAIN_MENU

    last = history[-10:]
    parts = []
    for i, item in enumerate(last, 1):
        parts.append(f"{i}) {item}")
    text = "üß∫ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—á—ë—Ç—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏:\n\n" + "\n\n---\n\n".join(parts)
    update.message.reply_text(text, reply_markup=main_menu_keyboard())
    return MAIN_MENU


def cmd_my_calcs(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    history = calc_history.get(str(chat_id), [])
    if not history:
        update.message.reply_text("–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.")
        return
    last = history[-10:]
    parts = []
    for i, item in enumerate(last, 1):
        parts.append(f"{i}) {item}")
    text = "üß∫ –¢–≤–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—á—ë—Ç—ã:\n\n" + "\n\n---\n\n".join(parts)
    update.message.reply_text(text)


def cmd_clear_calcs(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    key = str(chat_id)
    if key in calc_history:
        calc_history.pop(key, None)
        save_calcs(calc_history)
        update.message.reply_text("–¢–≤–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã —É–¥–∞–ª–µ–Ω—ã.")
    else:
        update.message.reply_text("–£ —Ç–µ–±—è –Ω–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.")


def cmd_export_calcs(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    history = calc_history.get(str(chat_id), [])
    if not history:
        update.message.reply_text("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—á–µ–≥–æ ‚Äî —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.")
        return

    filename = f"calcs_{chat_id}.txt"
    with open(filename, "w", encoding="utf-8") as f:
        f.write("–¢–≤–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –ø–æ —Å—Ç—Ä–æ–π–∫–µ:\n\n")
        for i, item in enumerate(history, 1):
            f.write(f"{i}) {item}\n\n")

    with open(filename, "rb") as f:
        update.message.reply_document(
            document=f,
            filename="stroi_calcs.txt",
            caption="–§–∞–π–ª —Å —Ç–≤–æ–∏–º–∏ —Ä–∞—Å—á—ë—Ç–∞–º–∏. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å –ø—Ä–æ—Ä–∞–±—É –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É.",
        )


# ---------- FLASK + –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ + –ê–í–¢–û–ü–ò–ù–ì ----------

app = Flask(__name__)


@app.route("/")
def index():
    return "Bot is running"


def check_admin_key(req) -> bool:
    password = os.getenv("ADMIN_PASSWORD")
    if not password:
        return False
    key = req.args.get("key") or req.form.get("key")
    return key == password


@app.route("/admin", methods=["GET"])
def admin_index():
    if not check_admin_key(request):
        return "Access denied. Wrong or missing key.", 403

    users_count = len(known_users)
    html = f"""
    <html>
    <head><title>Admin panel</title></head>
    <body>
      <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞</h2>
      <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>{users_count}</b></p>

      <h3>–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
      <form method="POST" action="/admin/broadcast">
        <input type="hidden" name="key" value="{request.args.get('key','')}"/>
        <textarea name="text" rows="5" cols="60" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏"></textarea><br><br>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
      </form>
    </body>
    </html>
    """
    return html


@app.route("/admin/broadcast", methods=["POST"])
def admin_broadcast():
    if not check_admin_key(request):
        return "Access denied. Wrong or missing key.", 403
    global telegram_bot
    if telegram_bot is None:
        return "Bot is not ready yet.", 500

    text = request.form.get("text", "").strip()
    if not text:
        return "–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç.", 400

    sent = 0
    errors = 0
    for uid in list(known_users):
        try:
            telegram_bot.send_message(chat_id=uid, text=text)
            sent += 1
        except Exception as e:
            logger.warning("–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ %s: %s", uid, e)
            errors += 1

    return f"–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}, –æ—à–∏–±–æ–∫: {errors}"


def run_web():
    app.run(host="0.0.0.0", port=8000)


def self_ping_loop():
    url = "http://127.0.0.1:8000/"
    while True:
        try:
            requests.get(url, timeout=5)
            logger.info("Self-ping OK: %s", url)
        except Exception as e:
            logger.warning("Self-ping failed: %s", e)
        time.sleep(300)  # 5 –º–∏–Ω—É—Ç


# ---------- –ó–ê–ü–£–°–ö –ë–û–¢–ê ----------

def main():
    global telegram_bot

    token = os.getenv("BOT_TOKEN")
    if not token:
        raise RuntimeError("–í Secrets –Ω–µ—Ç BOT_TOKEN")

    updater = Updater(token, use_context=True)
    telegram_bot = updater.bot

    dp = updater.dispatcher

    conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            MAIN_MENU: [MessageHandler(Filters.text & ~Filters.command, handle_main_menu)],
            MATERIAL_CATEGORY: [MessageHandler(Filters.text & ~Filters.command, handle_material_category)],
            COMPARE_FIRST: [MessageHandler(Filters.text & ~Filters.command, handle_compare_first)],
            COMPARE_SECOND: [MessageHandler(Filters.text & ~Filters.command, handle_compare_second)],
            REGION_NAME: [MessageHandler(Filters.text & ~Filters.command, handle_region_name)],
            REGION_CLIMATE: [MessageHandler(Filters.text & ~Filters.command, handle_region_climate)],
            REGION_GROUND: [MessageHandler(Filters.text & ~Filters.command, handle_region_ground)],
            MONTAGE_MATERIAL: [MessageHandler(Filters.text & ~Filters.command, handle_montage_material)],
            CALC_MATERIAL: [MessageHandler(Filters.text & ~Filters.command, handle_calc_material)],
            CALC_AREA: [MessageHandler(Filters.text & ~Filters.command, handle_calc_area)],
            AI_QUESTION: [MessageHandler(Filters.text & ~Filters.command, handle_ai_question)],
            ESTIMATE_AREA: [MessageHandler(Filters.text & ~Filters.command, handle_estimate_area)],
            ESTIMATE_FLOORS: [MessageHandler(Filters.text & ~Filters.command, handle_estimate_floors)],
            ESTIMATE_WALLS: [MessageHandler(Filters.text & ~Filters.command, handle_estimate_walls)],
            ESTIMATE_FINISH: [MessageHandler(Filters.text & ~Filters.command, handle_estimate_finish)],
            PROBLEM_TEXT: [MessageHandler(Filters.text & ~Filters.command, handle_problem_text)],
            PROJECT_AREA: [MessageHandler(Filters.text & ~Filters.command, handle_project_area)],
            PROJECT_FLOORS: [MessageHandler(Filters.text & ~Filters.command, handle_project_floors)],
            PROJECT_WALLS: [MessageHandler(Filters.text & ~Filters.command, handle_project_walls)],
            PROJECT_REGION: [MessageHandler(Filters.text & ~Filters.command, handle_project_region)],
            CONSTR_PYROG_TYPE: [MessageHandler(Filters.text & ~Filters.command, handle_pirog_type)],
            CONSTR_PYROG_REGION: [MessageHandler(Filters.text & ~Filters.command, handle_pirog_region)],
            CONSTR_PYROG_PRIORITY: [MessageHandler(Filters.text & ~Filters.command, handle_pirog_priority)],
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            CommandHandler("start", start),
        ],
    )

    dp.add_handler(conv)

    # –∫–æ–º–∞–Ω–¥—ã –≤–Ω–µ –¥–∏–∞–ª–æ–≥–∞
    dp.add_handler(CommandHandler("my_calcs", cmd_my_calcs))
    dp.add_handler(CommandHandler("clear_calcs", cmd_clear_calcs))
    dp.add_handler(CommandHandler("export_calcs", cmd_export_calcs))

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
    updater.start_polling()
    updater.idle()


if __name__ == "__main__":
    t_web = Thread(target=run_web, daemon=True)
    t_web.start()

    t_ping = Thread(target=self_ping_loop, daemon=True)
    t_ping.start()

    main()